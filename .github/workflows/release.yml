name: Build and Release Typst PDF

on:
    push:
        branches:
            - master

permissions:
    contents: write

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ§¾ Checkout repository
              uses: actions/checkout@v3

            - name: âš™ï¸ Install Typst
              run: |
                  curl -L https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz -o typst.tar.xz
                  tar -xf typst.tar.xz
                  sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/

            - name: ğŸ”¤ Install Fonts (ä¸­æ–‡ + Consolas + å¸¸ç”¨)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y fonts-cmu fonts-noto-cjk fonts-linuxlibertine ttf-mscorefonts-installer git unzip wget

                  mkdir -p ~/.fonts

                  # âœ… é»‘ä½“ã€å®‹ä½“ã€æ¥·ä½“ï¼ˆæ¥è‡ª StellarCN ä»“åº“ï¼‰
                  wget -O ~/.fonts/SimHei.ttf https://github.com/StellarCN/scp_zh/raw/master/fonts/SimHei.ttf
                  wget -O ~/.fonts/SimSun.ttf https://github.com/StellarCN/scp_zh/raw/master/fonts/SimSun.ttf
                  wget -O ~/.fonts/SimKai.ttf https://github.com/StellarCN/scp_zh/raw/master/fonts/SimKai.ttf

                  # âœ… Consolas å­—ä½“ï¼ˆæ¥è‡ª pensnarik ä»“åº“ï¼‰
                  git clone https://github.com/pensnarik/consolas-font.git
                  cp consolas-font/*.ttf ~/.fonts/

                  fc-cache -fv

            - name: ğŸ›  Compile Typst to PDF
              run: |
                  make

            - name: ğŸš€ Create GitHub Release
              id: create_release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ github.run_number }}
                  name: "Auto Release of DEMO #${{ github.run_number }}"
                  body: |
                      ğŸ“„ This PDF was automatically generated from commit `${{ github.sha }}`
                      ğŸ“ Commit message: ${{ github.event.head_commit.message }}
                      ğŸ”— Commit URL: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ“ Upload PDF to Release
              uses: softprops/action-gh-release@v1
              with:
                  files: ./builds/demo.pdf
                  tag_name: v${{ github.run_number }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
